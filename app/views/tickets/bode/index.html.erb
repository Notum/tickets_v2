<div class="space-y-4 sm:space-y-6" data-controller="delete-confirm">
  <h1 class="text-xl sm:text-2xl font-bold">Bode.lv Charter Flights</h1>

  <!-- Search Form Card -->
  <%
    # Build saved searches data for JS filtering
    saved_searches_data = @saved_searches.group_by(&:bode_destination_id).transform_values do |searches|
      searches.map { |s| { date_out: s.date_out.strftime("%d.%m.%Y"), date_in: s.date_in.strftime("%d.%m.%Y") } }
    end
  %>
  <div class="card bg-base-100 shadow-xl"
       data-controller="bode-search search-accordion"
       data-bode-search-saved-searches-value="<%= saved_searches_data.to_json %>"
       data-bode-search-selected-destination-value="<%= @selected_destination_id || '' %>"
       data-search-accordion-section-value="bode_search"
       data-search-accordion-expanded-value="<%= accordion_expanded?('bode_search') %>">
    <div class="card-body p-4 sm:p-6">
      <div class="flex items-center justify-between cursor-pointer" data-action="click->search-accordion#toggle">
        <h2 class="card-title text-base sm:text-lg">Search for Charter Flights from Riga</h2>
        <svg data-search-accordion-target="icon" class="w-5 h-5 transition-transform duration-200 <%= 'rotate-180' unless accordion_expanded?('bode_search') %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
        </svg>
      </div>

      <div data-search-accordion-target="content" class="<%= 'hidden' unless accordion_expanded?('bode_search') %>">
        <%= form_with url: tickets_bode_path, method: :post do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 items-end">
          <!-- Destination -->
          <div class="form-control">
            <label class="label" for="destination_id">
              <span class="label-text">Destination</span>
            </label>
            <select name="destination_id" id="destination_id"
                    class="select select-bordered w-full"
                    data-bode-search-target="destinationSelect"
                    data-action="change->bode-search#destinationChanged">
              <option value="">Select destination</option>
              <% @destinations.each do |destination| %>
                <option value="<%= destination.id %>" <%= 'selected' if @selected_destination_id == destination.id %>><%= destination.display_name %></option>
              <% end %>
            </select>
          </div>

          <!-- Flight Selection -->
          <div class="form-control" data-bode-search-target="flightContainer">
            <label class="label" for="flight_select">
              <span class="label-text">Available Flights</span>
            </label>
            <select name="flight_select" id="flight_select"
                    class="select select-bordered w-full"
                    data-bode-search-target="flightSelect"
                    data-action="change->bode-search#flightChanged">
              <option value="">Select a flight</option>
            </select>
          </div>

          <!-- Hidden fields for dates -->
          <input type="hidden" name="date_out" data-bode-search-target="dateOut">
          <input type="hidden" name="date_in" data-bode-search-target="dateIn">

          <!-- Submit Button -->
          <div class="form-control">
            <label class="label">
              <span class="label-text text-base-content/70" data-bode-search-target="tripInfo">&nbsp;</span>
            </label>
            <button type="submit"
                    class="btn btn-primary w-full"
                    data-bode-search-target="submitButton"
                    disabled>
              Save Flight Search
            </button>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div data-bode-search-target="loadingIndicator" class="hidden mt-4">
          <span class="loading loading-spinner loading-sm text-primary"></span>
          <span class="ml-2 text-sm text-base-content/70">Loading available flights...</span>
        </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Saved Searches Card -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
        <h2 class="card-title text-lg sm:text-xl">Your Saved Flight Searches</h2>
        <% if @saved_searches.any? && @saved_searches.first.priced_at.present? %>
          <span class="text-xs text-base-content/50">Updated <%= time_ago_in_words(@saved_searches.maximum(:priced_at)) %> ago</span>
        <% end %>
      </div>

      <% if @saved_searches.any? %>
        <!-- Mobile View -->
        <div class="lg:hidden space-y-3 mt-2" id="bode-searches-mobile">
          <% @saved_searches.each do |search| %>
            <div class="bg-base-200 rounded-lg p-3" id="<%= dom_id(search) %>-mobile">
              <!-- Header: Route + Actions -->
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0 flex-1">
                  <div class="font-medium text-sm truncate"><%= search.bode_destination.display_name %></div>
                  <div class="text-xs text-base-content/50">
                    (<%= search.trip_duration %> nights)
                    <% if search.airline.present? %>
                      <span class="ml-1">â€¢ <%= search.airline %></span>
                    <% end %>
                  </div>
                </div>
                <div class="flex items-center gap-1 shrink-0">
                  <% if search.order_url.present? %>
                    <a href="<%= search.order_url %>" target="_blank" class="btn btn-ghost btn-xs btn-square text-info" title="Buy">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                      </svg>
                    </a>
                  <% end %>
                  <button type="button" class="btn btn-ghost btn-xs btn-square text-error" title="Delete"
                          data-action="click->delete-confirm#open"
                          data-delete-confirm-url="<%= tickets_bode_delete_path(search.id) %>"
                          data-delete-confirm-message="Delete flight to <%= search.bode_destination.display_name %>?">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                  <% if search.pending? %>
                    <span class="badge badge-warning badge-xs">Pending</span>
                  <% elsif search.error? %>
                    <span class="badge badge-error badge-xs">Error</span>
                  <% end %>
                </div>
              </div>

              <!-- Dates -->
              <div class="mt-2 pt-2 border-t border-base-300">
                <div class="text-sm text-base-content/70">
                  <%= search.date_out.strftime("%d.%m.%Y") %> - <%= search.date_in.strftime("%d.%m.%Y") %>
                </div>
              </div>

              <!-- Price & Chart -->
              <div class="mt-2 pt-2 border-t border-base-300 flex items-center justify-between gap-3">
                <div>
                  <% if search.price %>
                    <p class="text-xl font-bold text-success"><%= search.price.to_i %>&euro;</p>
                    <% if search.free_seats.present? %>
                      <p class="text-xs text-base-content/50"><%= search.free_seats %> seats</p>
                    <% end %>
                  <% else %>
                    <p class="text-xl font-bold text-base-content/30">-</p>
                  <% end %>
                </div>
                <div class="flex-1 max-w-[140px]">
                  <% price_history = search.price_history_for_chart %>
                  <% if price_history.length >= 3 %>
                    <div data-controller="price-chart" data-price-chart-data-value="<%= price_history.to_json %>"></div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Desktop View -->
        <div class="hidden lg:block divide-y divide-base-300" id="bode-searches">
          <% @saved_searches.each do |search| %>
            <div class="py-3 flex items-center gap-4" id="<%= dom_id(search) %>">
              <!-- Route -->
              <div class="font-medium whitespace-nowrap w-64 shrink-0">
                <%= search.bode_destination.display_name %>
                <span class="text-xs text-base-content/50 font-normal ml-1">(<%= search.trip_duration %>n)</span>
              </div>

              <!-- Dates -->
              <div class="text-sm text-base-content/70 flex-1">
                <%= search.date_out.strftime("%d.%m.%Y") %> - <%= search.date_in.strftime("%d.%m.%Y") %>
                <% if search.airline.present? %>
                  <span class="text-xs text-base-content/50 ml-2">(<%= search.airline %>)</span>
                <% end %>
              </div>

              <!-- Price -->
              <div class="text-left shrink-0 w-24">
                <% if search.price %>
                  <p class="text-lg font-semibold text-success"><%= search.price.to_i %>&euro;</p>
                  <% if search.free_seats.present? %>
                    <p class="text-xs text-base-content/50"><%= search.free_seats %> seats</p>
                  <% end %>
                <% else %>
                  <p class="text-lg font-semibold text-base-content/30">-</p>
                <% end %>
              </div>

              <!-- Price Trend Chart -->
              <div class="shrink-0 w-[150px]">
                <% price_history = search.price_history_for_chart %>
                <% if price_history.length >= 3 %>
                  <div data-controller="price-chart" data-price-chart-data-value="<%= price_history.to_json %>"></div>
                <% end %>
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-1 shrink-0">
                <% if search.order_url.present? %>
                  <a href="<%= search.order_url %>" target="_blank" class="btn btn-ghost btn-sm btn-square text-info" title="Go to Buy">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                  </a>
                <% end %>
                <button type="button"
                        class="btn btn-ghost btn-sm btn-square text-error"
                        title="Delete"
                        data-action="click->delete-confirm#open"
                        data-delete-confirm-url="<%= tickets_bode_delete_path(search.id) %>"
                        data-delete-confirm-message="Are you sure you want to delete the flight search to <%= search.bode_destination.display_name %>?">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
                <% if search.pending? %>
                  <span class="badge badge-warning badge-xs ml-1">Pending</span>
                <% elsif search.error? %>
                  <span class="badge badge-error badge-xs ml-1">Error</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <h3 class="mt-2 font-medium">No flight searches</h3>
          <p class="mt-1 text-sm text-base-content/70">Get started by searching for a flight above.</p>
        </div>
      <% end %>
    </div>
  </div>

  <% if @destinations.empty? %>
    <div role="alert" class="alert alert-warning">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span>No destinations available. Please run <kbd class="kbd kbd-sm">bin/rails bode:sync_destinations</kbd> to fetch destinations.</span>
    </div>
  <% end %>

  <!-- Delete Confirmation Modal -->
  <dialog class="modal modal-bottom sm:modal-middle" data-delete-confirm-target="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold">Confirm Delete</h3>
      <p class="py-4" data-delete-confirm-target="message">Are you sure you want to delete this flight search?</p>
      <div class="modal-action">
        <button type="button" class="btn" data-action="click->delete-confirm#close">Cancel</button>
        <button type="button" class="btn btn-error" data-action="click->delete-confirm#confirm">Delete</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>
