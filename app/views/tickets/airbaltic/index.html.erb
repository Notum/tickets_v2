<div class="space-y-4 sm:space-y-6" data-controller="delete-confirm">
  <h1 class="text-xl sm:text-2xl font-bold">AirBaltic Flight Search</h1>

  <!-- Search Form Card -->
  <%
    # Build saved searches data for JS filtering
    # Structure: { destination_code: { date_out: [date_in, date_in, ...] } }
    saved_searches_data = {}
    @saved_searches.each do |search|
      code = search.airbaltic_destination.code
      date_out = search.date_out.to_s
      date_in = search.date_in.to_s
      saved_searches_data[code] ||= {}
      saved_searches_data[code][date_out] ||= []
      saved_searches_data[code][date_out] << date_in
    end
  %>
  <div class="card bg-base-100 shadow-xl"
       data-controller="airbaltic-search search-accordion"
       data-airbaltic-search-saved-searches-value="<%= saved_searches_data.to_json %>"
       data-airbaltic-search-selected-destination-value="<%= @selected_destination_code || '' %>"
       data-search-accordion-section-value="airbaltic_search"
       data-search-accordion-expanded-value="<%= accordion_expanded?('airbaltic_search') %>">
    <div class="card-body p-4 sm:p-6">
      <div class="flex items-center justify-between cursor-pointer" data-action="click->search-accordion#toggle">
        <h2 class="card-title text-base sm:text-lg">Search for Flights from Riga (RIX)</h2>
        <svg data-search-accordion-target="icon" class="w-5 h-5 transition-transform duration-200 <%= 'rotate-180' unless accordion_expanded?('airbaltic_search') %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
        </svg>
      </div>

      <div data-search-accordion-target="content" class="<%= 'hidden' unless accordion_expanded?('airbaltic_search') %>">
        <%= form_with url: tickets_airbaltic_path, method: :post do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4 items-end">
          <!-- Destination -->
          <div class="form-control">
            <label class="label" for="destination_code">
              <span class="label-text">Destination</span>
            </label>
            <select name="destination_code" id="destination_code"
                    class="select select-bordered w-full"
                    data-airbaltic-search-target="destinationSelect"
                    data-action="change->airbaltic-search#destinationChanged">
              <option value="">Select destination</option>
              <% @destinations.each do |destination| %>
                <option value="<%= destination.code %>" <%= 'selected' if @selected_destination_code == destination.code %>><%= destination.display_name %></option>
              <% end %>
            </select>
          </div>

          <!-- Date Out -->
          <div class="form-control" data-airbaltic-search-target="dateOutContainer" class="hidden">
            <label class="label" for="date_out">
              <span class="label-text">Flight Out</span>
            </label>
            <div data-airbaltic-search-target="monthFilterOut" class="flex flex-wrap gap-1 mb-1"></div>
            <select name="date_out" id="date_out"
                    class="select select-bordered w-full"
                    data-airbaltic-search-target="dateOutSelect"
                    data-action="change->airbaltic-search#dateOutChanged">
              <option value="">Select a date</option>
            </select>
          </div>

          <!-- Date In -->
          <div class="form-control" data-airbaltic-search-target="dateInContainer" class="hidden">
            <label class="label" for="date_in">
              <span class="label-text">Flight Back</span>
            </label>
            <div data-airbaltic-search-target="monthFilterIn" class="flex flex-wrap gap-1 mb-1"></div>
            <select name="date_in" id="date_in"
                    class="select select-bordered w-full"
                    data-airbaltic-search-target="dateInSelect"
                    data-action="change->airbaltic-search#dateInChanged">
              <option value="">Select a date</option>
            </select>
          </div>

          <!-- Submit Button -->
          <div class="form-control">
            <label class="label">
              <span class="label-text text-base-content/70" data-airbaltic-search-target="tripDuration">&nbsp;</span>
            </label>
            <button type="submit"
                    class="btn btn-primary w-full"
                    data-airbaltic-search-target="submitButton"
                    disabled>
              Save Flight Search
            </button>
          </div>
        </div>

        <!-- Hidden fields for prices -->
        <input type="hidden" name="price_out" data-airbaltic-search-target="priceOutInput">
        <input type="hidden" name="price_in" data-airbaltic-search-target="priceInInput">
        <input type="hidden" name="is_direct_out" data-airbaltic-search-target="isDirectOutInput">
        <input type="hidden" name="is_direct_in" data-airbaltic-search-target="isDirectInInput">

        <!-- Price Summary -->
        <div data-airbaltic-search-target="priceSummary" class="hidden mt-4 p-4 bg-base-200 rounded-lg">
          <div class="flex items-center justify-between">
            <span class="text-sm text-base-content/70">Total price:</span>
            <span class="text-xl font-bold text-success" data-airbaltic-search-target="totalPrice">-</span>
          </div>
        </div>

        <!-- No Flights Message -->
        <div data-airbaltic-search-target="noFlightsMessage" class="hidden mt-4 p-4 bg-warning/10 border border-warning/30 rounded-lg text-warning-content text-sm">
        </div>

        <!-- Loading Indicator -->
        <div data-airbaltic-search-target="loadingIndicator" class="hidden mt-4">
          <span class="loading loading-spinner loading-sm text-primary"></span>
          <span class="ml-2 text-sm text-base-content/70">Loading available dates...</span>
        </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Saved Searches Card -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
        <h2 class="card-title text-lg sm:text-xl">Your Saved Flight Searches</h2>
        <% if @saved_searches.any? && @saved_searches.first.priced_at.present? %>
          <span class="text-xs text-base-content/50">Updated <%= time_ago_in_words(@saved_searches.maximum(:priced_at)) %> ago</span>
        <% end %>
      </div>

      <% if @saved_searches.any? %>
        <!-- Mobile View -->
        <div class="lg:hidden space-y-3 mt-2" id="airbaltic-searches-mobile">
          <% @saved_searches.each do |search| %>
            <div class="bg-base-200 rounded-lg p-3" id="<%= dom_id(search) %>-mobile">
              <!-- Header: Route + Actions -->
              <div class="flex items-start justify-between gap-2">
                <div>
                  <div class="font-medium text-sm">
                    RIX <span class="text-base-content/50">→</span> <%= search.airbaltic_destination.display_name %> <span class="text-base-content/50">→</span> RIX
                  </div>
                  <div class="text-xs text-base-content/50">
                    (<%= search.trip_duration %> days)
                    <% if search.direct_flight? %>
                      <span class="badge badge-success badge-xs ml-1">Direct</span>
                    <% end %>
                  </div>
                </div>
                <div class="flex items-center gap-1">
                  <%= button_to tickets_airbaltic_refresh_price_path(search.id), method: :post, class: "btn btn-ghost btn-xs btn-square", title: "Refresh" do %>
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                  <% end %>
                  <button type="button" class="btn btn-ghost btn-xs btn-square text-error" title="Delete"
                          data-action="click->delete-confirm#open"
                          data-delete-confirm-url="<%= tickets_airbaltic_delete_path(search.id) %>"
                          data-delete-confirm-message="Delete flight to <%= search.airbaltic_destination.display_name %>?">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                  <% if search.pending? %>
                    <span class="badge badge-warning badge-xs">Pending</span>
                  <% elsif search.error? %>
                    <span class="badge badge-error badge-xs">Error</span>
                  <% end %>
                </div>
              </div>

              <!-- Dates -->
              <div class="mt-2 pt-2 border-t border-base-300">
                <div class="text-sm text-base-content/70">
                  <%= search.date_out.strftime("%d/%m/%Y") %> - <%= search.date_in.strftime("%d/%m/%Y") %>
                </div>
              </div>

              <!-- Price & Chart -->
              <div class="mt-2 pt-2 border-t border-base-300 flex items-center justify-between gap-3">
                <div>
                  <% if search.total_price %>
                    <p class="text-xl font-bold text-success">&euro;<%= number_with_precision(search.total_price, precision: 2) %></p>
                  <% else %>
                    <p class="text-xl font-bold text-base-content/30">-</p>
                  <% end %>
                </div>
                <div class="flex-1 max-w-[140px]">
                  <% price_history = search.price_history_for_chart %>
                  <% if price_history.length >= 3 %>
                    <div data-controller="price-chart" data-price-chart-data-value="<%= price_history.to_json %>"></div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Desktop View -->
        <div class="hidden lg:block divide-y divide-base-300" id="airbaltic-searches">
          <% @saved_searches.each do |search| %>
            <div class="py-3 flex items-center gap-4" id="<%= dom_id(search) %>">
              <!-- Route -->
              <div class="font-medium whitespace-nowrap w-52 shrink-0">
                RIX <span class="text-base-content/50">→</span> <%= search.airbaltic_destination.display_name %> <span class="text-base-content/50">→</span> RIX
                <span class="text-xs text-base-content/50 font-normal ml-1">(<%= search.trip_duration %>d)</span>
              </div>

              <!-- Dates -->
              <div class="text-sm text-base-content/70 flex-1">
                <%= search.date_out.strftime("%d/%m/%Y") %> - <%= search.date_in.strftime("%d/%m/%Y") %>
                <% if search.direct_flight? %>
                  <span class="badge badge-success badge-xs ml-2">Direct</span>
                <% end %>
              </div>

              <!-- Price -->
              <div class="text-left shrink-0 w-24">
                <% if search.total_price %>
                  <p class="text-lg font-semibold text-success">&euro;<%= number_with_precision(search.total_price, precision: 2) %></p>
                <% else %>
                  <p class="text-lg font-semibold text-base-content/30">-</p>
                <% end %>
              </div>

              <!-- Price Trend Chart -->
              <div class="shrink-0 w-[150px]">
                <% price_history = search.price_history_for_chart %>
                <% if price_history.length >= 3 %>
                  <div data-controller="price-chart" data-price-chart-data-value="<%= price_history.to_json %>"></div>
                <% end %>
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-1 shrink-0">
                <%= button_to tickets_airbaltic_refresh_price_path(search.id), method: :post, class: "btn btn-ghost btn-sm btn-square", title: "Refresh price" do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                <% end %>
                <button type="button"
                        class="btn btn-ghost btn-sm btn-square text-error"
                        title="Delete"
                        data-action="click->delete-confirm#open"
                        data-delete-confirm-url="<%= tickets_airbaltic_delete_path(search.id) %>"
                        data-delete-confirm-message="Are you sure you want to delete the flight search to <%= search.airbaltic_destination.display_name %>?">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
                <% if search.pending? %>
                  <span class="badge badge-warning badge-xs ml-1">Pending</span>
                <% elsif search.error? %>
                  <span class="badge badge-error badge-xs ml-1">Error</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <h3 class="mt-2 font-medium">No flight searches</h3>
          <p class="mt-1 text-sm text-base-content/70">Get started by searching for a flight above.</p>
        </div>
      <% end %>
    </div>
  </div>

  <% if @destinations.empty? %>
    <div role="alert" class="alert alert-warning">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span>No destinations available. Please run <kbd class="kbd kbd-sm">bin/rails airbaltic:seed_destinations</kbd> to add destinations.</span>
    </div>
  <% end %>

  <!-- Delete Confirmation Modal -->
  <dialog class="modal modal-bottom sm:modal-middle" data-delete-confirm-target="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold">Confirm Delete</h3>
      <p class="py-4" data-delete-confirm-target="message">Are you sure you want to delete this flight search?</p>
      <div class="modal-action">
        <button type="button" class="btn" data-action="click->delete-confirm#close">Cancel</button>
        <button type="button" class="btn btn-error" data-action="click->delete-confirm#confirm">Delete</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>
