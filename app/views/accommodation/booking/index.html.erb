<div class="space-y-4 sm:space-y-6" data-controller="delete-confirm">
  <h1 class="text-xl sm:text-2xl font-bold">Booking.com Hotel Price Tracker</h1>

  <!-- Search Form Card -->
  <%
    saved_searches_data = {}
    @saved_searches.each do |search|
      key = "#{search.hotel_id}_#{search.room_id}_#{search.check_in}_#{search.check_out}"
      saved_searches_data[key] = true
    end
  %>
  <div class="card bg-base-100 shadow-xl"
       data-controller="booking-search search-accordion"
       data-booking-search-saved-searches-value="<%= saved_searches_data.to_json %>"
       data-booking-search-currency-value="<%= @currency %>"
       data-search-accordion-section-value="booking_search"
       data-search-accordion-expanded-value="<%= accordion_expanded?('booking_search') %>">
    <div class="card-body p-4 sm:p-6">
      <div class="flex items-center justify-between cursor-pointer" data-action="click->search-accordion#toggle">
        <h2 class="card-title text-base sm:text-lg">Search for Hotels</h2>
        <svg data-search-accordion-target="icon" class="w-5 h-5 transition-transform duration-200 <%= 'rotate-180' unless accordion_expanded?('booking_search') %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
        </svg>
      </div>

      <div data-search-accordion-target="content" class="<%= 'hidden' unless accordion_expanded?('booking_search') %>">
        <%= form_with url: accommodation_booking_path, method: :post, data: { booking_search_target: "form" } do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
          <!-- City -->
          <div class="form-control">
            <label class="label" for="city_name">
              <span class="label-text">City</span>
            </label>
            <input type="text" name="city_name" id="city_name"
                   class="input input-bordered w-full"
                   placeholder="e.g., Calpe, Barcelona"
                   data-booking-search-target="cityInput"
                   data-action="input->booking-search#cityChanged"
                   required>
          </div>

          <!-- Hotel Name -->
          <div class="form-control">
            <label class="label" for="hotel_name_search">
              <span class="label-text">Hotel/Apartment Name</span>
            </label>
            <input type="text" name="hotel_name_search" id="hotel_name_search"
                   class="input input-bordered w-full"
                   placeholder="e.g., Port Europa"
                   data-booking-search-target="hotelNameInput"
                   required>
          </div>

          <!-- Check-in Date -->
          <div class="form-control">
            <label class="label" for="check_in">
              <span class="label-text">Check-in</span>
            </label>
            <input type="date" name="check_in" id="check_in"
                   class="input input-bordered w-full"
                   data-booking-search-target="checkInInput"
                   data-action="change->booking-search#checkInChanged"
                   min="<%= Date.current.to_s %>"
                   required>
          </div>

          <!-- Check-out Date -->
          <div class="form-control">
            <label class="label" for="check_out">
              <span class="label-text">Check-out</span>
            </label>
            <input type="date" name="check_out" id="check_out"
                   class="input input-bordered w-full"
                   data-booking-search-target="checkOutInput"
                   data-action="change->booking-search#checkOutChanged"
                   disabled
                   required>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4 items-end">
          <!-- Adults -->
          <div class="form-control">
            <label class="label" for="adults">
              <span class="label-text">Adults</span>
            </label>
            <select name="adults" id="adults" class="select select-bordered w-full">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>

          <!-- Rooms -->
          <div class="form-control">
            <label class="label" for="rooms">
              <span class="label-text">Rooms</span>
            </label>
            <select name="rooms" id="rooms" class="select select-bordered w-full">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>

          <!-- Search Button -->
          <div class="form-control">
            <label class="label">
              <span class="label-text text-base-content/70" data-booking-search-target="stayDuration">&nbsp;</span>
            </label>
            <button type="button"
                    class="btn btn-secondary w-full"
                    data-booking-search-target="searchButton"
                    data-action="click->booking-search#searchHotels">
              Search Hotels
            </button>
          </div>

          <!-- Submit Button (hidden until hotel selected) -->
          <div class="form-control">
            <label class="label">
              <span class="label-text">&nbsp;</span>
            </label>
            <button type="submit"
                    class="btn btn-primary w-full"
                    data-booking-search-target="submitButton"
                    disabled>
              Save & Track Price
            </button>
          </div>
        </div>

        <!-- Hidden fields for selected hotel -->
        <input type="hidden" name="hotel_id" data-booking-search-target="hotelIdInput">
        <input type="hidden" name="hotel_name" data-booking-search-target="hotelNameHiddenInput">
        <input type="hidden" name="hotel_url" data-booking-search-target="hotelUrlInput">
        <input type="hidden" name="country_name" data-booking-search-target="countryNameInput">

        <!-- Hidden fields for selected room -->
        <input type="hidden" name="room_id" data-booking-search-target="roomIdInput">
        <input type="hidden" name="block_id" data-booking-search-target="blockIdInput">
        <input type="hidden" name="room_name" data-booking-search-target="roomNameInput">

        <!-- Loading Indicator -->
        <div data-booking-search-target="loadingIndicator" class="hidden mt-4">
          <span class="loading loading-spinner loading-sm text-primary"></span>
          <span class="ml-2 text-sm text-base-content/70">Searching hotels on Booking.com...</span>
        </div>

        <!-- Hotel Results -->
        <div data-booking-search-target="hotelResults" class="hidden mt-4">
          <h3 class="font-medium mb-2">Select a hotel to track:</h3>
          <div data-booking-search-target="hotelList" class="grid gap-2"></div>
        </div>

        <!-- Room Loading Indicator -->
        <div data-booking-search-target="roomLoading" class="hidden mt-4">
          <span class="loading loading-spinner loading-sm text-primary"></span>
          <span class="ml-2 text-sm text-base-content/70">Loading available rooms...</span>
        </div>

        <!-- Room Results -->
        <div data-booking-search-target="roomResults" class="hidden mt-4">
          <h3 class="font-medium mb-2">Select a room to track:</h3>
          <div data-booking-search-target="roomList" class="grid gap-2 max-h-60 overflow-y-auto"></div>
        </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Saved Searches Card -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
        <h2 class="card-title text-lg sm:text-xl">Your Tracked Hotels</h2>
        <% if @saved_searches.any? && @saved_searches.first.priced_at.present? %>
          <span class="text-xs text-base-content/50">Updated <%= time_ago_in_words(@saved_searches.maximum(:priced_at)) %> ago</span>
        <% end %>
      </div>

      <% if @saved_searches.any? %>
        <!-- Mobile View -->
        <div class="lg:hidden space-y-3 mt-2" id="booking-searches-mobile">
          <% @saved_searches.each do |search| %>
            <div class="bg-base-200 rounded-lg p-3" id="<%= dom_id(search) %>-mobile">
              <!-- Header: Hotel Name + Actions -->
              <div class="flex items-start justify-between gap-2">
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-sm truncate"><%= search.hotel_name %></div>
                  <div class="text-xs text-base-content/50"><%= search.city_name %></div>
                </div>
                <div class="flex items-center gap-1 shrink-0">
                  <%= button_to accommodation_booking_refresh_price_path(search.id), method: :post, class: "btn btn-ghost btn-xs btn-square", title: "Refresh" do %>
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                  <% end %>
                  <button type="button" class="btn btn-ghost btn-xs btn-square text-error" title="Delete"
                          data-action="click->delete-confirm#open"
                          data-delete-confirm-url="<%= accommodation_booking_delete_path(search.id) %>"
                          data-delete-confirm-message="Delete tracking for <%= search.hotel_name %>?">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                  <% if search.pending? %>
                    <span class="badge badge-warning badge-xs">Pending</span>
                  <% elsif search.error? %>
                    <span class="badge badge-error badge-xs">Error</span>
                  <% elsif search.room_sold_out? %>
                    <span class="badge badge-neutral badge-xs">Room Sold Out</span>
                  <% elsif search.sold_out? %>
                    <span class="badge badge-neutral badge-xs">Sold Out</span>
                  <% end %>
                </div>
              </div>

              <!-- Dates -->
              <div class="mt-2 pt-2 border-t border-base-300">
                <div class="text-xs text-base-content/70">
                  <%= search.check_in.strftime("%d/%m/%Y") %> - <%= search.check_out.strftime("%d/%m/%Y") %>
                  (<%= search.stay_duration %> nights)
                </div>
                <% if search.room_name.present? %>
                  <div class="text-xs text-base-content/50 mt-1"><%= search.room_name %></div>
                <% end %>
              </div>

              <!-- Price & Chart -->
              <div class="mt-2 pt-2 border-t border-base-300 flex items-center justify-between gap-3">
                <div>
                  <% if search.price %>
                    <p class="text-xl font-bold text-success"><%= search.currency_symbol %><%= number_with_precision(search.price, precision: 2) %></p>
                    <% if search.price_per_night %>
                      <p class="text-xs text-base-content/50"><%= search.currency_symbol %><%= number_with_precision(search.price_per_night, precision: 2) %>/night</p>
                    <% end %>
                  <% else %>
                    <p class="text-xl font-bold text-base-content/30">-</p>
                  <% end %>
                </div>
                <div class="flex-1 max-w-[140px]">
                  <% price_history = search.price_history_for_chart %>
                  <% if price_history.length >= 3 %>
                    <div data-controller="price-chart" data-price-chart-data-value="<%= price_history.to_json %>"></div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Desktop View -->
        <div class="hidden lg:block divide-y divide-base-300" id="booking-searches">
          <% @saved_searches.each do |search| %>
            <div class="py-3 flex items-center gap-4" id="<%= dom_id(search) %>">
              <!-- Hotel Name & City -->
              <div class="w-64 shrink-0">
                <div class="font-medium truncate" title="<%= search.hotel_name %>"><%= search.hotel_name %></div>
                <div class="text-xs text-base-content/50"><%= search.city_name %></div>
              </div>

              <!-- Dates -->
              <div class="flex-1 text-center">
                <div class="text-sm">
                  <%= search.check_in.strftime("%d/%m/%Y") %> - <%= search.check_out.strftime("%d/%m/%Y") %>
                </div>
                <div class="text-xs text-base-content/50">
                  <%= search.stay_duration %> nights, <%= search.adults %> adults
                </div>
                <% if search.room_name.present? %>
                  <div class="text-xs text-base-content/50 truncate max-w-[200px] mx-auto" title="<%= search.room_name %>"><%= search.room_name %></div>
                <% end %>
              </div>

              <!-- Price -->
              <div class="text-left shrink-0 w-28">
                <% if search.price %>
                  <p class="text-lg font-semibold text-success"><%= search.currency_symbol %><%= number_with_precision(search.price, precision: 2) %></p>
                  <% if search.price_per_night %>
                    <p class="text-xs text-base-content/50"><%= search.currency_symbol %><%= number_with_precision(search.price_per_night, precision: 2) %>/night</p>
                  <% end %>
                <% else %>
                  <p class="text-lg font-semibold text-base-content/30">-</p>
                <% end %>
              </div>

              <!-- Price Trend Chart -->
              <div class="shrink-0 w-[150px]">
                <% price_history = search.price_history_for_chart %>
                <% if price_history.length >= 3 %>
                  <div data-controller="price-chart" data-price-chart-data-value="<%= price_history.to_json %>"></div>
                <% end %>
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-1 shrink-0">
                <a href="<%= search.booking_url %>" target="_blank" class="btn btn-ghost btn-sm btn-square" title="Open on Booking.com">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </a>
                <%= button_to accommodation_booking_refresh_price_path(search.id), method: :post, class: "btn btn-ghost btn-sm btn-square", title: "Refresh price" do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                <% end %>
                <button type="button"
                        class="btn btn-ghost btn-sm btn-square text-error"
                        title="Delete"
                        data-action="click->delete-confirm#open"
                        data-delete-confirm-url="<%= accommodation_booking_delete_path(search.id) %>"
                        data-delete-confirm-message="Are you sure you want to stop tracking <%= search.hotel_name %>?">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
                <% if search.pending? %>
                  <span class="badge badge-warning badge-xs ml-1">Pending</span>
                <% elsif search.error? %>
                  <span class="badge badge-error badge-xs ml-1">Error</span>
                <% elsif search.room_sold_out? %>
                  <span class="badge badge-neutral badge-xs ml-1">Room Sold Out</span>
                <% elsif search.sold_out? %>
                  <span class="badge badge-neutral badge-xs ml-1">Sold Out</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          <h3 class="mt-2 font-medium">No hotels tracked</h3>
          <p class="mt-1 text-sm text-base-content/70">Search for a hotel above to start tracking prices.</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <dialog class="modal modal-bottom sm:modal-middle" data-delete-confirm-target="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold">Confirm Delete</h3>
      <p class="py-4" data-delete-confirm-target="message">Are you sure you want to delete this hotel search?</p>
      <div class="modal-action">
        <button type="button" class="btn" data-action="click->delete-confirm#close">Cancel</button>
        <button type="button" class="btn btn-error" data-action="click->delete-confirm#confirm">Delete</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>
